
# news feed系统
## 要求阐述：
	时间倒序，多少个好友，网络流量，新闻可以包含图片和视频
## 两个流程：
	发布feed，
	构建news feed
## API：
- 发布feed ，包含 content, auth_token
` POST /vi/me/feed`
- 获取news feed, 包含auth_token参数
` GET /vi/me/feed`

## Feed发布
- 用户：
- 负载均衡器： 把流量分配到多个Web服务器上
- Web服务器： 把请求重定向到不同的内部服务
- 帖子服务：将帖子持久化到数据库和缓存中

![[Pasted image 20240308103029.png]]


## 广播服务：

- 写广播： 推送模型。
	优点：
	- 实时推送
	- 获取news feed很快
	缺点：
	- 如果有很多好友，获取好友列表并为所有人生成feed很慢。热键问题Hotkey Problem。
	- 对不活跃的用户或者那些很少登录的用户，浪费计算资源
- 读广播： 拉取模型
	- 优点：
		- 解决写广播的缺点
	- 缺点：
		- 慢


## 缓存架构
![[Pasted image 20240308104405.png]]

## 其他话题
- 数据库拓展：
	- 纵向扩展与横向扩展
	- 关系型数据库与NoSQL
	- 主从复制
	- 读副本
	- 一致性模型
	- 数据库分片

- 其他话题：
	- 保持网络层无状态
	- 缓存尽量多的数据
	- 支持多数据中心
	- 通过消息队列来解耦组件
	- 监控关键指标。高峰期的QPS和刷新feed的延时。

# 设计聊天系统

## 理解问题

	1. 5000万的日活用户（DAU）
	2. 一对一聊天，消息延时低
	3. 小型群组<100人
	4. 展示在线状态，意思是如果离线，先储存信息
	5. 多设备
	6. 推送


## 高层级的设计并获得认同

- 从服务器端发送消息 - 模拟服务器发起连接的技术
	1. 轮询（polling)
	2. 长轮询 (long polling)
		1. 效率低
		2. 无法判断是否客户端断开了连接
		3. 发送者和接受者可能没有连接到同一个服务器，http是无状态的，所以可能没有办法保持long polling
	3. WebSocket - 异步更新最常用的方案


- 无状态服务：请求、响应服务，用于管理登陆，注册，用户信息等。位于负载均衡器之后。
- 有状态服务：聊天。

## 数据库：

1. 通用数据 - 个人信息，设置、好友列表
	1. 关系型数据库 - 数据库分片和复制
2. 聊天数据
	1. 数据量大，messenger 600亿
	2. 最近的聊天记录被访问，也可以搜索
	3. 一对一聊天 读写比率1：1
	4. 键值存储轻松横向拓展
	5. 数据访问延时低
	6. 关系数据库不能很好处理长尾数据。索引大的时候，随机访问开销大
3. 聊天表
4. ![[Pasted image 20240308110842.png]]
5. ![[Pasted image 20240308110852.png]]

	消息ID：
		唯一
		时间排序：一般是mysql的auto-increment
		64位序列号生成器，比如snowflake
		本地序列号生成器。
	群聊消息：
		发送消息，消息会被复制到每个群成员的消息同步队列中
	![[Pasted image 20240308112606.png]]
	判断是否在线、离线：
		心跳机制：
			客户端每五秒想服务器发送一次心跳时间，3次后断开连接，如果XX内没有重新连接，就显示离线
### 总结
- 拓展聊天系统支持多媒体文件
- 端到端加密
- 在客户端缓存消息，减少client end 和 server end之间的数据传输
- 缩短加载时间。
- 错误处理

### 
	